function loadImage(e){var t=new Image;t.onload=function(){selectedItem&&contractItem(selectedItem),selectedFilter&&setSelectedFilter(null),selectedItem=null,hideDialog(),init(t)},t.src=e}function showDialog(){$("#fade").fadeIn(),$("#dialog").show().css({top:-$("#dialog").outerHeight()}).animate({top:0})}function hideDialog(){$("#fade").fadeOut(),$("#dialog").animate({top:-$("#dialog").outerHeight()},function(){$("#dialog").hide()})}function contractItem(e){$(e).removeClass("active").animate({paddingTop:0}),$(e).children(".contents").slideUp()}function expandItem(e){$(e).addClass("active").animate({paddingTop:10}),$(e).children(".contents").slideDown()}function setSelectedFilter(e){if(canvas2d.getContext("2d").clearRect(0,0,canvas2d.width,canvas2d.height),$("#nubs").html(""),selectedFilter=e,e){for(var t=0;t<e.sliders.length;t++){var a=e.sliders[t];$("#"+a.id).slider("value",a.value)}for(var t=0;t<e.curves.length;t++){var i=e.curves[t];e[i.name]=[[0,0],[1,1]],i.draw()}for(var t=0;t<e.segmented.length;t++){var s=e.segmented[t];$("#"+s.id+"-"+s.initial).mousedown()}for(var t=0;t<e.nubs.length;t++){var n=e.nubs[t],r=n.x*canvas.width,d=n.y*canvas.height;$('<div class="nub" id="nub'+t+'"></div>').appendTo("#nubs");var l=function(t){return function(a,i){var s=$(a.target.parentNode).offset();e[t.name]={x:i.offset.left-s.left,y:i.offset.top-s.top},e.update()}}(n);$("#nub"+t).draggable({drag:l,containment:"parent",scroll:!1}).css({left:r,top:d}),e[n.name]={x:r,y:d}}e.reset&&e.reset(),e.update()}else canvas.draw(texture).update()}function init(e){texture&&texture.destroy(),texture=canvas.texture(e),canvas.draw(texture).update(),$("#nubs").css({width:e.width,height:e.height}),canvas2d.width=e.width,canvas2d.height=e.height,selectedItem&&contractItem(selectedItem),setSelectedFilter(null),selectedItem=null,$("#loading").hide()}function Filter(e,t,a,i){this.name=e,this.update=a,this.reset=i,this.sliders=[],this.curves=[],this.segmented=[],this.nubs=[],t.call(this)}var canvas,canvas2d,texture,selectedItem,selectedFilter;$(window).load(function(){if(!window.fx)return void $("#loading").html("Could not load glfx.js, please check your internet connection");try{canvas=fx.canvas().replace($("#placeholder")[0])}catch(e){return void $("#loading").html('<div class="sadface">:(</div>Sorry, but this browser doesn\'t support WebGL.<br>Please see <a href="http://www.khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">Getting a WebGL implementation</a>')}canvas2d=$("#canvas2d")[0];var t=0;for(var a in filters){$('<div class="header">'+a+"</div>").appendTo("#sidebar");for(var i=0;i<filters[a].length;i++){for(var s=filters[a][i],n='<div class="item"><div class="title">'+s.name+'</div><div class="contents"><table>',r=0;r<s.sliders.length;r++){var d=s.sliders[r];d.id="control"+t++,n+="<tr><td>"+d.label+':</td><td><div class="slider" id="'+d.id+'"></div></td></tr>'}for(var r=0;r<s.segmented.length;r++){var l=s.segmented[r];l.id="control"+t++,n+="<tr><td>"+l.label+':</td><td><div class="segmented">';for(var o=0;o<l.labels.length;o++)n+='<div class="segment'+(o==l.initial?" selected":"")+'" id="'+l.id+"-"+o+'">'+l.labels[o]+"</div>";n+="</div></td></tr>"}n+="</table>";for(var r=0;r<s.curves.length;r++){var c=s.curves[r];c.id="control"+t++,n+='<canvas class="curves" id="'+c.id+'"></canvas>'}n+='<div class="button accept">Accept</div><div class="reset">Reset</div></div></div>';var h=$(n).appendTo("#sidebar")[0];h.filter=s,function(e){$(h).find(".reset").click(function(){setSelectedFilter(e)})}(s);for(var r=0;r<s.segmented.length;r++){var l=s.segmented[r];s[l.name]=l.initial;for(var o=0;o<l.labels.length;o++)$("#"+l.id+"-"+o).mousedown(function(e,t,a){return function(){e[t.name]=a;for(var i=0;i<t.labels.length;i++)$("#"+t.id+"-"+i)[a==i?"addClass":"removeClass"]("selected");e.update()}}(s,l,o))}for(var r=0;r<s.nubs.length;r++){var u=s.nubs[r],g=u.x*canvas.width,v=u.y*canvas.height;s[u.name]={x:g,y:v}}for(var r=0;r<s.curves.length;r++){var c=s.curves[r];!function(e,t){function a(){0==c[0]&&(l=c[1]),1==c[0]&&(o=c[1]);for(var a=t[e.name],i=!1,s=!1,n=0;n<a.length;n++){var r=a[n];0==r[0]?(i=!0,0==c[0]&&r!=c&&a.splice(n--,1)):1==r[0]&&(s=!0,1==c[0]&&r!=c&&a.splice(n--,1))}i||a.push([0,l]),s||a.push([1,o])}function i(e){var t=$(s).offset(),a=Math.max(0,Math.min(1,(e.pageX-t.left)/r)),i=Math.max(0,Math.min(1,1-(e.pageY-t.top)/d));return[a,i]}var s=$("#"+e.id)[0],n=s.getContext("2d"),r=s.width=$(s).width(),d=s.height=$(s).height(),l=0,o=1;e.draw=function(){var a=t[e.name],i=fx.splineInterpolate(a);n.clearRect(0,0,r,d),n.strokeStyle="#4B4947",n.beginPath();for(var s=0;s<i.length;s++)n.lineTo(s/i.length*r,(1-i[s]/255)*d);n.stroke(),n.fillStyle="white";for(var s=0;s<a.length;s++){var l=a[s];n.beginPath(),n.arc(l[0]*r,(1-l[1])*d,3,0,2*Math.PI,!1),n.fill()}};var c,h=!1;$(s).mousedown(function(s){var n=t[e.name];c=i(s);for(var l=0;l<n.length;l++){var o=n[l],u=(o[0]-c[0])*r,g=(o[1]-c[1])*d;if(25>u*u+g*g){c=o;break}}l==n.length&&n.push(c),h=!0,a(),e.draw(),t.update()}),$(document).mousemove(function(s){if(h){var n=i(s);c[0]=n[0],c[1]=n[1],a(),e.draw(),t.update()}}),$(document).mouseup(function(){h=!1}),t[e.name]=[[0,0],[1,1]],e.draw()}(c,s)}for(var r=0;r<s.sliders.length;r++){var d=s.sliders[r];s[d.name]=d.value;var f=function(e,t){return function(a,i){e[t.name]=i.value,selectedFilter==e&&e.update()}}(s,d);$("#"+d.id).slider({slide:f,change:f,min:d.min,max:d.max,value:d.value,step:d.step})}}}$("#sidebar .item .title").live("mousedown",function(e){var t=e.target.parentNode;selectedItem&&contractItem(selectedItem),selectedItem!=t?(expandItem(t),selectedItem=t,setSelectedFilter(t.filter)):(setSelectedFilter(null),selectedItem=null)}),$(".accept").live("click",function(){contractItem(selectedItem),texture.destroy(),texture=canvas.contents(),setSelectedFilter(null),selectedItem=null}),$("#load").click(function(){$("#dialog").html('<div class="contents">Pick one of the sample images below or upload an image of your own:<div class="images"><img class="loader" src="samples/mountain.jpg" height="100"><img class="loader" src="samples/smoke.jpg" height="100"><img class="loader" src="samples/face.jpg" height="100"><img class="loader" src="samples/cat.jpg" height="100"><img class="loader" src="samples/greyhound.jpg" height="100"><img class="loader" src="samples/sunset.jpg" height="100"><img class="loader" src="samples/leaf.jpg" height="100"><img class="loader" src="samples/perspective.jpg" height="100"></div><div class="credits">Flickr image credits in order: <a href="http://www.flickr.com/photos/matthigh/2125630879/">matthigh</a>, <a href="http://www.flickr.com/photos/delosj/5816379127/">delosj</a>, <a href="http://www.flickr.com/photos/stuckincustoms/219537913/">stuckincustoms</a>, <a href="http://www.flickr.com/photos/pasma/580401331/">pasma</a>, <a href="http://www.flickr.com/photos/delosj/5546225759/">delosj</a>, <a href="http://www.flickr.com/photos/seriousbri/3736154699/">seriousbri</a>, <a href="http://www.flickr.com/photos/melisande-origami/157818928/">melisande-origami</a>, and <a href="http://www.flickr.com/photos/stuckincustoms/4669163231/">stuckincustoms</a></div></div><div class="button"><input type="file" class="upload">Upload File...</div><div class="button closedialog">Cancel</div>'),showDialog()}),$("#dialog input.upload").live("change",function(e){var t=new FileReader;t.onload=function(e){loadImage(e.target.result)},t.readAsDataURL(e.target.files[0])}),$("#dialog img.loader").live("mousedown",function(e){loadImage(e.target.src)}),$("#save").click(function(){window.open(canvas.toDataURL("image/png"))}),$("#about").click(function(){$("#dialog").html('<div class="contents">Copyright 2011 <a href="http://madebyevan.com">Evan Wallace</a><br><br>This application is powered by <a href="http://evanw.github.com/glfx.js/">glfx.js</a>, an open-source image effect library that uses WebGL.&nbsp; The source code for this application is also <a href="http://github.com/evanw/webgl-filter/">available on GitHub</a>.</div><div class="button closedialog">Close</div>'),showDialog()}),$(".closedialog").live("click",function(){hideDialog()}),loadImage("samples/mountain.jpg")}),Filter.prototype.addNub=function(e,t,a){this.nubs.push({name:e,x:t,y:a})},Filter.prototype.addCurves=function(e){this.curves.push({name:e})},Filter.prototype.addSegmented=function(e,t,a,i){this.segmented.push({name:e,label:t,labels:a,initial:i})},Filter.prototype.addSlider=function(e,t,a,i,s,n){this.sliders.push({name:e,label:t,min:a,max:i,value:s,step:n})};var filters={Adjust:[new Filter("Brightness / Contrast",function(){this.addSlider("brightness","Brightness",-1,1,0,.01),this.addSlider("contrast","Contrast",-1,1,0,.01)},function(){canvas.draw(texture).brightnessContrast(this.brightness,this.contrast).update()}),new Filter("Hue / Saturation",function(){this.addSlider("hue","Hue",-1,1,0,.01),this.addSlider("saturation","Saturation",-1,1,0,.01)},function(){canvas.draw(texture).hueSaturation(this.hue,this.saturation).update()}),new Filter("Curves",function(){this.addCurves("points")},function(){canvas.draw(texture).curves(this.points).update()}),new Filter("Denoise",function(){this.addSlider("strength","Strength",0,1,.5,.01)},function(){canvas.draw(texture).denoise(3+200*Math.pow(1-this.strength,4)).update()}),new Filter("Unsharp Mask",function(){this.addSlider("radius","Radius",0,200,20,1),this.addSlider("strength","Strength",0,5,2,.01)},function(){canvas.draw(texture).unsharpMask(this.radius,this.strength).update()})],Blur:[new Filter("Zoom Blur",function(){this.addNub("center",.5,.5),this.addSlider("strength","Strength",0,1,.3,.01)},function(){canvas.draw(texture).zoomBlur(this.center.x,this.center.y,this.strength).update()}),new Filter("Triangle Blur",function(){this.addSlider("radius","Radius",0,200,50,1)},function(){canvas.draw(texture).triangleBlur(this.radius).update()}),new Filter("Tilt Shift",function(){this.addNub("start",.15,.75),this.addNub("end",.75,.6),this.addSlider("blurRadius","Radius",0,50,15,1),this.addSlider("gradientRadius","Thickness",0,400,200,1)},function(){canvas.draw(texture).tiltShift(this.start.x,this.start.y,this.end.x,this.end.y,this.blurRadius,this.gradientRadius).update()}),new Filter("Lens Blur",function(){this.addSlider("radius","Radius",0,50,10,1),this.addSlider("brightness","Brightness",-1,1,.75,.01),this.addSlider("angle","Angle",0,Math.PI,0,.01)},function(){canvas.draw(texture).lensBlur(this.radius,this.brightness,this.angle).update()})],Warp:[new Filter("Swirl",function(){this.addNub("center",.5,.5),this.addSlider("angle","Angle",-25,25,3,.1),this.addSlider("radius","Radius",0,600,200,1)},function(){canvas.draw(texture).swirl(this.center.x,this.center.y,this.radius,this.angle).update()}),new Filter("Bulge / Pinch",function(){this.addNub("center",.5,.5),this.addSlider("strength","Strength",-1,1,.5,.01),this.addSlider("radius","Radius",0,600,200,1)},function(){canvas.draw(texture).bulgePinch(this.center.x,this.center.y,this.radius,this.strength).update()}),new Filter("Perspective",function(){this.addSegmented("showAfter","Edit point set",["Before","After"],1),this.addNub("a",.25,.25),this.addNub("b",.75,.25),this.addNub("c",.25,.75),this.addNub("d",.75,.75);var e=this.update;this.update=function(){e.call(this);var t=canvas2d.getContext("2d");t.clearRect(0,0,canvas2d.width,canvas2d.height);for(var a=0;2>a;a++)t.beginPath(),t.lineTo(this.a.x,this.a.y),t.lineTo(this.b.x,this.b.y),t.lineTo(this.d.x,this.d.y),t.lineTo(this.c.x,this.c.y),t.closePath(),t.lineWidth=a?2:4,t.strokeStyle=a?"white":"black",t.stroke()}},function(){var e=[this.a.x,this.a.y,this.b.x,this.b.y,this.c.x,this.c.y,this.d.x,this.d.y];this.showAfter?(this.after=e,canvas.draw(texture).perspective(this.before,this.after).update()):(this.before=e,canvas.draw(texture).update())},function(){var e=canvas.width,t=canvas.height;this.before=[0,0,e,0,0,t,e,t],this.after=[this.a.x,this.a.y,this.b.x,this.b.y,this.c.x,this.c.y,this.d.x,this.d.y]})],Fun:[new Filter("Ink",function(){this.addSlider("strength","Strength",0,1,.25,.01)},function(){canvas.draw(texture).ink(this.strength).update()}),new Filter("Edge Work",function(){this.addSlider("radius","Radius",0,200,10,1)},function(){canvas.draw(texture).edgeWork(this.radius).update()}),new Filter("Hexagonal Pixelate",function(){this.addNub("center",.5,.5),this.addSlider("scale","Scale",10,100,20,1)},function(){canvas.draw(texture).hexagonalPixelate(this.center.x,this.center.y,this.scale).update()}),new Filter("Dot Screen",function(){this.addNub("center",.5,.5),this.addSlider("angle","Angle",0,Math.PI/2,1.1,.01),this.addSlider("size","Size",3,20,3,.01)},function(){canvas.draw(texture).dotScreen(this.center.x,this.center.y,this.angle,this.size).update()}),new Filter("Color Halftone",function(){this.addNub("center",.5,.5),this.addSlider("angle","Angle",0,Math.PI/2,1.1,.01),this.addSlider("size","Size",3,20,4,.01)},function(){canvas.draw(texture).colorHalftone(this.center.x,this.center.y,this.angle,this.size).update()})]};